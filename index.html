<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дуа при посещении могил</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            position: relative;
        }

        .frame {
            position: relative;
            width: 800px;
            height: 1200px;
            overflow: hidden;
            margin-bottom: 80px;
        }

        .background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #008460;
            border-radius: 40px;
            z-index: 1;
        }

        .calligraphy {
            position: absolute;
            width: 700px;
            height: 281px;
            left: 50%;
            transform: translateX(-50%);
            top: 50px;
            background: url('arabic-calligraphy.png') no-repeat center center;
            background-size: contain;
            z-index: 3;
        }

        .text-container {
            position: absolute;
            width: 700px;
            left: 50%;
            transform: translateX(-50%);
            top: 384px;
            z-index: 3;
            text-align: center;
        }

        .dua-rus {
            font-weight: 700;
            font-size: 30px;
            color: #FFFFFF;
            margin-bottom: 20px;
        }

        .dua-arab {
            font-family: 'Lateef', serif;
            font-size: 37px;
            color: #FFFFFF;
            direction: rtl;
            line-height: 1.8;
            margin-bottom: 20px;
            text-align: center;
            width: 100%;
        }

        .dua-translate {
            font-size: 16px;
            color: #FFFFFF;
            line-height: 1.5;
            text-align: center;
        }

        .qr-section {
            position: absolute;
            width: 700px;
            left: 50%;
            transform: translateX(-50%);
            top: 845px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3;
        }

        .qr-code {
            width: 300px;
            height: 300px;
            background-color: #008460;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .qr-instruction {
            width: 350px;
            font-size: 22px;
            color: #FFFFFF;
            line-height: 1.4;
            text-align: center;
        }

        .download-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: #05D59C;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            min-width: 250px;
            text-align: center;
        }

        .download-btn:hover {
            background-color: #04C38D;
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .download-btn:active {
            transform: translateX(-50%) translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Lateef&display=swap" rel="stylesheet">

    <!-- Яндекс.Метрика -->
    <script type="text/javascript">
        (function (m, e, t, r, i, k, a) {
            m[i] = m[i] || function () { (m[i].a = m[i].a || []).push(arguments) };
            m[i].l = 1 * new Date();
            k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
        })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(103498789, "init", {
            id: 103498789,
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true,
            webvisor: true,
            trackHash: true,
            ecommerce: "dataLayer",
            params: window.location.search.substring(1)
        });
    </script>
    <noscript>
        <div><img src="https://mc.yandex.ru/watch/103498789" style="position:absolute; left:-9999px;" alt="" /></div>
    </noscript>

    <!-- Библиотеки -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>
    <div class="frame" id="capture-area">
        <div class="background"></div>
        <div class="calligraphy"></div>

        <div class="text-container">
            <div class="dua-rus">
                При входе на кладбище <br> поприветствуйте обитателей могил:
            </div>

            <div class="dua-arab">
                السَّلَامُ عَلَيْكُمْ أَهْلَ الدِّيَارِ مِنَ الْمُؤْمِنِينَ وَالْمُسْلِمِينَ، وَإِنَّا إِنْ شَاءَ
                اللَّهُ بِكُمْ <br>لَاحِقُونَ، أَسْأَلُ اللَّهَ لَنَا وَلَكُمُ الْعَافِيَةَ
            </div>

            <div class="dua-translate">
                Транскрипция: Ас-саляму аляйкум ахля-д-дияри мин аль-му'минина валь-муслимина, ва инна ин шаа Аллаху
                бикум ляхикун, ас'алю-Ллаха ляна ва лякум аль-афия<br><br>
                Перевод: «Мир вам, о обитатели этих могил из числа верующих и мусульман!<br> Поистине, мы, если пожелает
                Аллах, присоединимся к вам. Я прошу Аллаха о <br> благополучии для нас и для вас»
            </div>
        </div>

        <div class="qr-section">
            <div id="qr-code" class="qr-code"></div>
            <div class="qr-instruction">
                <b>Отсканируйте QR-код</b><br><br>
                Возьмите с собой дуа, которые читал наш Пророк во время посещения могил!<br><br>
                И пусть Всевышний примет ваши поминания!
            </div>
        </div>
    </div>

    <button class="download-btn" id="download-btn">Скачать изображение</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. Определение параметров местоположения
            const urlParams = new URLSearchParams(window.location.search);
            const locationData = {
                city: urlParams.get('city') || 'unknown_city',
                cemetery: urlParams.get('cemetery') || 'general',
                placement: urlParams.get('placement') || 'unknown_placement',
                material: urlParams.get('material') || 'paper',
                campaign: 'graves_dua_v3'
            };

            // 2. Генерация уникального ID QR-кода
            const generateQRId = () => {
                const locationCode = `${locationData.city.slice(0, 3)}_${locationData.cemetery.slice(0, 3)}`.toUpperCase();
                return `${locationCode}_${Date.now()}_${Math.random().toString(36).substr(2, 4)}`;
            };

            const qrId = generateQRId();

            // 3. Формирование URL с параметрами отслеживания
            const buildTrackingUrl = () => {
                const baseUrl = 'https://zeerat.ru';
                const url = new URL(baseUrl);

                // Стандартные UTM-метки
                url.searchParams.append('utm_source', 'qr_code');
                url.searchParams.append('utm_medium', 'print');
                url.searchParams.append('utm_campaign', locationData.campaign);
                url.searchParams.append('utm_content', qrId);
                url.searchParams.append('utm_term', locationData.placement);

                // Дополнительные параметры для аналитики
                url.searchParams.append('qr_city', locationData.city);
                url.searchParams.append('qr_cemetery', locationData.cemetery);
                url.searchParams.append('qr_placement', locationData.placement);
                url.searchParams.append('qr_material', locationData.material);

                return url.toString();
            };

            const qrData = buildTrackingUrl();

            // 4. Отправка данных в Яндекс.Метрику
            ym(103498789, 'params', {
                qr_id: qrId,
                qr_city: locationData.city,
                qr_cemetery: locationData.cemetery,
                qr_placement: locationData.placement,
                qr_material: locationData.material,
                qr_campaign: locationData.campaign,
                generation_time: new Date().toISOString(),
                page_url: window.location.href
            });

            // 5. Генерация QR-кода
            QRCode.toCanvas(
                qrData,
                {
                    errorCorrectionLevel: 'H',
                    margin: 1,
                    color: { dark: '#ffffff', light: '#008460' },
                    width: 280
                },
                function (error, canvas) {
                    if (error) {
                        console.error('Ошибка генерации QR-кода:', error);
                        ym(103498789, 'reachGoal', 'qr_error', {
                            error: error.message,
                            location: `${locationData.city}_${locationData.cemetery}`
                        });
                        return;
                    }

                    document.getElementById('qr-code').appendChild(canvas);

                    // Фиксация успешной генерации
                    ym(103498789, 'reachGoal', 'qr_displayed', {
                        qr_id: qrId,
                        location: `${locationData.city}_${locationData.cemetery}`,
                        placement: locationData.placement,
                        size: '280x280'
                    });
                }
            );

            // 6. Отправка eCommerce данных
            ym(103498789, 'ecommerce', 'detail', {
                qr_id: qrId,
                products: [{
                    id: qrId,
                    name: 'QR Дуа для кладбища',
                    category: 'islamic_content',
                    brand: 'Zeerat',
                    variant: locationData.material,
                    price: 0,
                    quantity: 1,
                    dimension1: locationData.city,
                    dimension2: locationData.placement
                }]
            });

            // 7. Функция для добавления метаданных 300 DPI в JPEG
            async function add300DPItoJPEG(blob) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function () {
                        const arrayBuffer = this.result;
                        const uint8Array = new Uint8Array(arrayBuffer);

                        // XMP-метаданные с 300 DPI
                        const xmpMetadata = `
                            <?xpacket begin="" id="W5M0MpCehiHzreSzNTczkc9d"?>
                            <x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="Adobe XMP Core 5.6-c138 79.159824">
                                <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
                                    <rdf:Description rdf:about="" xmlns:tiff="http://ns.adobe.com/tiff/1.0/">
                                        <tiff:XResolution>300/1</tiff:XResolution>
                                        <tiff:YResolution>300/1</tiff:YResolution>
                                        <tiff:ResolutionUnit>2</tiff:ResolutionUnit>
                                    </rdf:Description>
                                </rdf:RDF>
                            </x:xmpmeta>
                            <?xpacket end="w"?>
                        `.replace(/\n\s+/g, ''); // Удаляем лишние пробелы

                        // Находим маркер конца JPEG (0xFFD9)
                        const endMarkerIndex = findJPEGEndMarker(uint8Array);
                        if (endMarkerIndex === -1) {
                            console.warn("Не удалось найти конец JPEG. Метаданные не добавлены.");
                            resolve(blob);
                            return;
                        }

                        // Вставляем XMP перед маркером конца
                        const xmpBytes = new TextEncoder().encode(xmpMetadata);
                        const newArray = new Uint8Array(uint8Array.length + xmpBytes.length);
                        newArray.set(uint8Array.subarray(0, endMarkerIndex), 0);
                        newArray.set(xmpBytes, endMarkerIndex);
                        newArray.set(uint8Array.subarray(endMarkerIndex), endMarkerIndex + xmpBytes.length);

                        resolve(new Blob([newArray], { type: 'image/jpeg' }));
                    };
                    reader.readAsArrayBuffer(blob);
                });
            }

            // Поиск маркера конца JPEG (0xFFD9)
            function findJPEGEndMarker(uint8Array) {
                for (let i = uint8Array.length - 2; i >= 0; i--) {
                    if (uint8Array[i] === 0xFF && uint8Array[i + 1] === 0xD9) {
                        return i;
                    }
                }
                return -1;
            }

            // 8. Обработчик кнопки скачивания с 300 DPI
            document.getElementById('download-btn').addEventListener('click', async function () {
                const element = document.getElementById('capture-area');
                const btn = this;

                btn.textContent = 'Готовим изображение...';
                btn.disabled = true;

                // Коэффициент масштабирования для 300 DPI
                const scale = 3.125; // 300 DPI / 96 DPI

                // Рендерим в canvas с увеличенным разрешением
                const canvas = await html2canvas(element, {
                    scale: scale,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#008460',
                    letterRendering: true,
                });

                // Конвертируем в JPEG (95% качества)
                canvas.toBlob(async function (blob) {
                    try {
                        // Добавляем метаданные 300 DPI
                        const blobWith300DPI = await add300DPItoJPEG(blob);

                        // Скачиваем файл
                        const url = URL.createObjectURL(blobWith300DPI);
                        const link = document.createElement('a');
                        link.download = `dua-${qrId}.jpg`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);

                        btn.textContent = 'Скачать изображение';
                        btn.disabled = false;
                    } catch (err) {
                        console.error("Ошибка при добавлении 300 DPI:", err);
                        btn.textContent = 'Ошибка! Попробуйте ещё раз';
                        setTimeout(() => {
                            btn.textContent = 'Скачать изображение';
                            btn.disabled = false;
                        }, 2000);
                    }
                }, 'image/jpeg', 0.95);
            });
        });
    </script>
</body>

</html>