<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дуа при посещении могил</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            position: relative;
        }

        .frame {
            position: relative;
            width: 800px;
            height: 1200px;
            overflow: hidden;
            margin-bottom: 80px;
        }

        .background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #008460;
            border-radius: 40px;
            z-index: 1;
        }

        .calligraphy {
            position: absolute;
            width: 700px;
            height: 281px;
            left: 50%;
            transform: translateX(-50%);
            top: 50px;
            background: url('arabic-calligraphy.png') no-repeat center center;
            background-size: contain;
            z-index: 3;
        }

        .text-container {
            position: absolute;
            width: 700px;
            left: 50%;
            transform: translateX(-50%);
            top: 384px;
            z-index: 3;
            text-align: center;
        }

        .dua-rus {
            font-weight: 700;
            font-size: 30px;
            color: #FFFFFF;
            margin-bottom: 20px;
        }

        .dua-arab {
            font-family: 'Lateef', serif;
            font-size: 37px;
            color: #FFFFFF;
            direction: rtl;
            line-height: 1.8;
            margin-bottom: 20px;
            text-align: center;
            width: 100%;
        }

        .dua-translate {
            font-size: 16px;
            color: #FFFFFF;
            line-height: 1.5;
            text-align: center;
        }

        .qr-section {
            position: absolute;
            width: 700px;
            left: 50%;
            transform: translateX(-50%);
            top: 845px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 3;
        }

        .qr-code {
            width: 300px;
            height: 300px;
            background-color: #008460;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .qr-instruction {
            width: 350px;
            font-size: 22px;
            color: #FFFFFF;
            line-height: 1.4;
            text-align: center;
        }

        .download-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background-color: #05D59C;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            min-width: 250px;
            text-align: center;
        }

        .download-btn:hover {
            background-color: #04C38D;
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .download-btn:active {
            transform: translateX(-50%) translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Lateef&display=swap" rel="stylesheet">

    <!-- Яндекс.Метрика -->
    <script type="text/javascript">
        (function (m, e, t, r, i, k, a) {
            m[i] = m[i] || function () { (m[i].a = m[i].a || []).push(arguments) };
            m[i].l = 1 * new Date();
            k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
        })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(103498789, "init", {
            id: 103498789,
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true,
            webvisor: true,
            trackHash: true,
            ecommerce: "dataLayer",
            params: window.location.search.substring(1)
        });
    </script>
    <noscript>
        <div><img src="https://mc.yandex.ru/watch/103498789" style="position:absolute; left:-9999px;" alt="" /></div>
    </noscript>

    <!-- Библиотеки -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
</head>

<body>
    <div class="frame" id="capture-area">
        <div class="background"></div>
        <div class="calligraphy"></div>

        <div class="text-container">
            <div class="dua-rus">
                При входе на кладбище <br> поприветствуйте обитателей могил:
            </div>

            <div class="dua-arab">
                السَّلَامُ عَلَيْكُمْ أَهْلَ الدِّيَارِ مِنَ الْمُؤْمِنِينَ وَالْمُسْلِمِينَ، وَإِنَّا إِنْ شَاءَ
                اللَّهُ بِكُمْ <br>لَاحِقُونَ، أَسْأَلُ اللَّهَ لَنَا وَلَكُمُ الْعَافِيَةَ
            </div>

            <div class="dua-translate">
                Транскрипция: Ас-саляму аляйкум ахля-д-дияри мин аль-му'минина валь-муслимина, ва инна ин шаа Аллаху
                бикум ляхикун, ас'алю-Ллаха ляна ва лякум аль-афия<br><br>
                Перевод: «Мир вам, о обитатели этих могил из числа верующих и мусульман!<br> Поистине, мы, если пожелает
                Аллах, присоединимся к вам. Я прошу Аллаха о <br> благополучии для нас и для вас»
            </div>
        </div>

        <div class="qr-section">
            <div id="qr-code" class="qr-code"></div>
            <div class="qr-instruction">
                <b>Отсканируйте QR-код</b><br><br>
                Возьмите с собой дуа, которые читал наш Пророк во время посещения могил!<br><br>
                И пусть Всевышний примет ваши поминания!
            </div>
        </div>
    </div>

    <button class="download-btn" id="download-btn">Скачать TIFF (300 DPI)</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. Определение параметров местоположения
            const urlParams = new URLSearchParams(window.location.search);
            const locationData = {
                city: urlParams.get('city') || 'unknown_city',
                cemetery: urlParams.get('cemetery') || 'general',
                placement: urlParams.get('placement') || 'unknown_placement',
                material: urlParams.get('material') || 'paper',
                campaign: 'graves_dua_v3'
            };

            // 2. Генерация уникального ID QR-кода
            const generateQRId = () => {
                const locationCode = `${locationData.city.slice(0, 3)}_${locationData.cemetery.slice(0, 3)}`.toUpperCase();
                return `${locationCode}_${Date.now()}_${Math.random().toString(36).substr(2, 4)}`;
            };

            const qrId = generateQRId();

            // 3. Формирование URL с параметрами отслеживания
            const buildTrackingUrl = () => {
                const baseUrl = 'https://zeerat.ru';
                const url = new URL(baseUrl);

                url.searchParams.append('utm_source', 'qr_code');
                url.searchParams.append('utm_medium', 'print');
                url.searchParams.append('utm_campaign', locationData.campaign);
                url.searchParams.append('utm_content', qrId);
                url.searchParams.append('utm_term', locationData.placement);
                url.searchParams.append('qr_city', locationData.city);
                url.searchParams.append('qr_cemetery', locationData.cemetery);
                url.searchParams.append('qr_placement', locationData.placement);
                url.searchParams.append('qr_material', locationData.material);

                return url.toString();
            };

            const qrData = buildTrackingUrl();

            // 4. Отправка данных в Яндекс.Метрику
            ym(103498789, 'params', {
                qr_id: qrId,
                qr_city: locationData.city,
                qr_cemetery: locationData.cemetery,
                qr_placement: locationData.placement,
                qr_material: locationData.material,
                qr_campaign: locationData.campaign,
                generation_time: new Date().toISOString(),
                page_url: window.location.href
            });

            // 5. Генерация QR-кода
            QRCode.toCanvas(
                qrData,
                {
                    errorCorrectionLevel: 'H',
                    margin: 1,
                    color: { dark: '#ffffff', light: '#008460' },
                    width: 280
                },
                function (error, canvas) {
                    if (error) {
                        console.error('Ошибка генерации QR-кода:', error);
                        ym(103498789, 'reachGoal', 'qr_error', {
                            error: error.message,
                            location: `${locationData.city}_${locationData.cemetery}`
                        });
                        return;
                    }

                    document.getElementById('qr-code').appendChild(canvas);
                    ym(103498789, 'reachGoal', 'qr_displayed', {
                        qr_id: qrId,
                        location: `${locationData.city}_${locationData.cemetery}`,
                        placement: locationData.placement,
                        size: '280x280'
                    });
                }
            );

            // 6. Функция для создания TIFF
            function generateTIFF(canvas, dpi) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const rgba = imageData.data;

                // Конвертируем RGBA в RGB
                const rgb = new Uint8Array(canvas.width * canvas.height * 3);
                for (let i = 0, j = 0; i < rgba.length; i += 4, j += 3) {
                    rgb[j] = rgba[i];     // R
                    rgb[j + 1] = rgba[i + 1]; // G
                    rgb[j + 2] = rgba[i + 2]; // B
                }

                // Устанавливаем метаданные DPI
                const ifd = [
                    { tag: 256, type: 4, value: [canvas.width] },  // ImageWidth
                    { tag: 257, type: 4, value: [canvas.height] }, // ImageLength
                    { tag: 258, type: 3, value: [8, 8, 8] },         // BitsPerSample
                    { tag: 259, type: 3, value: [1] },             // Compression (1 = none)
                    { tag: 262, type: 3, value: [2] },             // PhotometricInterpretation (RGB)
                    { tag: 273, type: 4, value: [8] },             // StripOffsets
                    { tag: 277, type: 3, value: [3] },             // SamplesPerPixel
                    { tag: 278, type: 4, value: [canvas.height] }, // RowsPerStrip
                    { tag: 279, type: 4, value: [rgb.length] },    // StripByteCounts
                    { tag: 282, type: 5, value: [dpi, 1] },        // XResolution (DPI)
                    { tag: 283, type: 5, value: [dpi, 1] },        // YResolution (DPI)
                    { tag: 296, type: 3, value: [2] }              // ResolutionUnit (inches)
                ];

                // Создаем TIFF файл
                const tiff = UTIF.encodeImage(rgb, canvas.width, canvas.height, ifd);
                return new Blob([tiff], { type: 'image/tiff' });
            }

            // 7. Обработчик кнопки скачивания
            document.getElementById('download-btn').addEventListener('click', function () {
                const element = document.getElementById('capture-area');
                const btn = this;

                btn.textContent = 'Готовим TIFF...';
                btn.disabled = true;

                ym(103498789, 'reachGoal', 'download_started', {
                    qr_id: qrId,
                    location: locationData.city,
                    format: 'tiff'
                });

                // Увеличиваем масштаб для 300 DPI
                const scale = 300 / 96; // 96 DPI - стандарт для экранов
                const width = element.offsetWidth * scale;
                const height = element.offsetHeight * scale;

                html2canvas(element, {
                    scale: scale,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#008460',
                    width: width,
                    height: height,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight
                }).then(canvas => {
                    // Создаем TIFF
                    const tiffBlob = generateTIFF(canvas, 300);
                    const url = URL.createObjectURL(tiffBlob);

                    // Создаем ссылку для скачивания
                    const link = document.createElement('a');
                    link.download = `dua-card-${qrId}.tiff`;
                    link.href = url;
                    link.click();

                    // Освобождаем память
                    setTimeout(() => URL.revokeObjectURL(url), 100);

                    btn.textContent = 'Скачать TIFF (300 DPI)';
                    btn.disabled = false;

                    ym(103498789, 'reachGoal', 'download_completed', {
                        qr_id: qrId,
                        file_type: 'tiff',
                        dpi: 300,
                        file_size: (tiffBlob.size / 1024).toFixed(2) + 'KB'
                    });
                }).catch(err => {
                    console.error('Ошибка создания изображения:', err);
                    btn.textContent = 'Скачать TIFF (300 DPI)';
                    btn.disabled = false;

                    ym(103498789, 'reachGoal', 'download_error', {
                        error: err.message,
                        qr_id: qrId
                    });
                });
            });
        });
    </script>
</body>

</html>