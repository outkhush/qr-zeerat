<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Генератор пропуска с QR-кодом</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        #downloadBtn {
            margin: 20px 0;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        #downloadBtn:hover {
            background: #45a049;
        }

        #preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .container {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Пропуск с QR-кодом</h1>

    <div class="container">
        <img id="preview" src="entrance-qr-dua.jpg" alt="Превью пропуска">
    </div>

    <button id="downloadBtn">Скачать пропуск (300 DPI)</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const downloadBtn = document.getElementById('downloadBtn');
            const previewImg = document.getElementById('preview');

            // Проверяем доступные форматы изображения
            let imageSrc = 'entrance-qr-dua.jpg';
            // Если есть TIFF версия, можно использовать ее (но потребуется конвертация)

            // Загружаем основное изображение
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = function () {
                processImage(img);
            };
            img.src = imageSrc;

            function processImage(originalImg) {
                // Создаем canvas с высоким разрешением для 300 DPI
                const dpi = 300;
                const scale = dpi / 96; // 96 - стандартный DPI экрана

                const canvas = document.createElement('canvas');
                canvas.width = originalImg.width * scale;
                canvas.height = originalImg.height * scale;

                const ctx = canvas.getContext('2d');

                // Устанавливаем высокое качество
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';

                // Рисуем оригинальное изображение
                ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);

                // Генерируем QR-код
                generateQR(ctx, canvas, scale);

                // Обновляем превью (в меньшем размере)
                updatePreview(canvas);

                // Настраиваем кнопку скачивания
                setupDownload(canvas);
            }

            function generateQR(ctx, canvas, scale) {
                // Генерация уникального URL
                const uniqueParam = Math.random().toString(36).substring(2, 9);
                const url = `https://zeerat.ru?ref=${uniqueParam}`;

                // Размер QR-кода (в пикселях с учетом масштаба)
                const qrSize = 1.5 * 300; // 1.5 inch * 300 DPI

                // Создаем временный контейнер для QR-кода
                const qrContainer = document.createElement('div');
                new QRCode(qrContainer, {
                    text: url,
                    width: qrSize,
                    height: qrSize,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Получаем QR-код как изображение
                const qrImg = new Image();
                qrImg.onload = function () {
                    // Позиция QR-кода (правый нижний угол с отступами)
                    const margin = 0.5 * 300; // 0.5 inch * 300 DPI
                    const x = canvas.width - qrSize - margin;
                    const y = canvas.height - qrSize - margin;

                    // Рисуем QR-код на основном изображении
                    ctx.drawImage(qrImg, x, y, qrSize, qrSize);

                    // Обновляем превью после добавления QR-кода
                    updatePreview(canvas);
                };
                qrImg.src = qrContainer.querySelector('canvas').toDataURL();
            }

            function updatePreview(canvas) {
                // Создаем уменьшенную версию для превью
                const previewCanvas = document.createElement('canvas');
                previewCanvas.width = 800;
                previewCanvas.height = (canvas.height / canvas.width) * 800;

                const previewCtx = previewCanvas.getContext('2d');
                previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);

                // Обновляем изображение превью
                previewImg.src = previewCanvas.toDataURL('image/jpeg', 0.9);
            }

            function setupDownload(canvas) {
                downloadBtn.onclick = function () {
                    // Создаем ссылку для скачивания
                    const link = document.createElement('a');
                    link.download = 'zeerat-pass.jpg';
                    link.href = canvas.toDataURL('image/jpeg', 1.0);
                    link.click();
                };
            }
        });
    </script>
</body>

</html>